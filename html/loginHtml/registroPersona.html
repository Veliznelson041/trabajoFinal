<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Persona</title>
  <link rel="stylesheet" href="../../css/loginCss/register.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <!-- Leaflet CSS y JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
      color: #333;
      min-height: 100vh;
      padding-bottom: 60px;
    }
    
    header {
      background: linear-gradient(to right, #ff0101, #7a1414);
      color: white;
      padding: 15px 5%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    
    .header-container {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 10px;
    }
    
    .logo {
      height: 50px;
      border-radius: 8px;
    }
    
    #title {
      font-size: 1.8rem;
      font-weight: 600;
    }
    
    #date-time {
      text-align: right;
      font-size: 0.9rem;
      opacity: 0.9;
      margin-bottom: 10px;
    }
    
    .nav-bar ul {
      display: flex;
      list-style: none;
      gap: 20px;
    }
    
    .nav-bar a {
      color: white;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s ease;
      padding: 8px 12px;
      border-radius: 5px;
    }
    
    .nav-bar a:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .btn-login {
      background: #560202;
      padding: 8px 15px;
      border-radius: 5px;
    }
    
    .btn-login:hover {
      background: #2980b9;
    }
    
    .ruta {
      padding: 15px 5%;
      background: #f8f9fa;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      font-size: 0.9rem;
    }
    
    .ruta a {
      color: #db3434;
      text-decoration: none;
    }
    
    .ruta a:hover {
      text-decoration: underline;
    }
    
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
    }
    
    h1 {
      text-align: center;
      margin: 20px 0 30px;
      color: #2c3e50;
      font-size: 2.2rem;
      position: relative;
      padding-bottom: 15px;
    }
    
    h1::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background: linear-gradient(to right, #780202, #ff0000);
      border-radius: 2px;
    }
    
    /* Diseño de formulario optimizado */
    .form-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .form-section {
      flex: 1;
      min-width: 300px;
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 25px rgba(0,0,0,0.08);
    }
    
    .map-section {
      flex: 1;
      min-width: 300px;
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 25px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      margin-top: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    label {
      font-weight: 600;
      color: #2c3e50;
      font-size: 0.95rem;
    }
    
    input, select {
      padding: 12px 15px;
      border: 2px solid #e1e5eb;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    input:focus, select:focus {
      border-color: #3498db;
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    small {
      font-size: 0.85rem;
      color: #6c757d;
      line-height: 1.4;
    }
    
    .error {
      color: #e74c3c;
      font-size: 0.85rem;
    }
    .error-field {
      border-color: #e74c3c !important;
    }
    .success-field {
      border-color: #2ecc71 !important;
    }
    .map-container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin: 20px auto;
      max-width: 1000px;
    }
    #map {
      height: 400px; /* Altura fija para PC */
      border-radius: 10px;
      margin-top: 10px;
      border: 1px solid #e1e5eb;
      flex-grow: 1;
    }
    
    .coordinates {
      margin-top: 15px;
      font-size: 0.9rem;
      background: #f8f9fa;
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid #e1e5eb;
    }
    .map-controls {
      display: flex;
      gap: 12px;
      margin-top: 15px;
      justify-content: center;
    }
    .map-controls button {
      padding: 8px 15px;
      background: #3498db;
      color: white;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    
    .map-control:hover {
      background: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    
    .map-control i {
      font-size: 1.2rem;
    }
    
    #btn-confirm {
      background: #2ecc71;
      display: none;
    }
    
    #btn-confirm:hover {
      background: #27ae60;
    }
    
    /* Vista previa de imagen */
    #image-preview-container {
      display: none;
      margin-top: 10px;
      text-align: center;
    }
    
    #image-preview {
      max-width: 250px;
      max-height: 250px;
      border-radius: 8px;
      border: 2px solid #e1e5eb;
      margin-bottom: 10px;
    }
    
    #remove-image {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    .map-controls button:hover {
      background: #2980b9;
    }
    .coordinates {
      margin-top: 15px;
      font-size: 0.9rem;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
    }
  </style>
</head>

<body>
  <header>
    <div class="header-container">
      <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRt_eZYMvS26mdHNwVQw-zHWqDRdSz5XzAVHQ&s"
        alt="Logo de Suplementos Dynamite" class="logo" />
      <h1 id="title">Suplementos Dynamite</h1>
    </div>
    <p id="date-time"></p>
    <nav class="nav-bar">
      <ul>
        <li><a href="../index.html">Inicio</a></li>
        <li><a href="/html/catalogo-Carrito-Producto-HTML/catalogo.html">Catálogo</a></li>
        <li><a href="../contactoHtml/contacto.html">Contacto</a></li>
        <li><a href="../administradorhtml/listadoPersonas.html">Personas Registradas</a></li>
        <li><a href="/html/loginHtml/login.html" class="btn-login"><i class="fas fa-user"></i> Iniciar Sesión</a></li>
      </ul>
    </nav>
  </header>

  <nav class="ruta">
    <a href="../index.html">Inicio</a> &gt;
    <a href="login.html">Iniciar Sesión</a> &gt;
    <a href="../loginHtml/register.html">Registrarse</a>
  </nav>

  <div class="container">
    <h1>Registro de Persona</h1>
    <form id="register-form" novalidate>
      <label for="nombres">Nombres:</label>
      <input type="text" id="nombre" name="nombre" required aria-describedby="help-nombres"/>
      <small class="error" id="error-nombre"></small>
      <small id="help-nombres">Solo letras. No se permiten números ni símbolos.</small>

      <label for="apellidos">Apellidos:</label>
      <input type="text" id="apellido" name="apellido" required aria-describedby="help-apellidos"/>
      <small class="error" id="error-apellido"></small>
      <small id="help-apellidos">Solo letras. No se permiten números ni símbolos.</small>

      <label for="dni">DNI:</label>
      <input type="text" id="dni" name="dni" required maxlength="8" minlength="7" aria-describedby="help-dni"/>
      <small class="error" id="error-dni"></small>
      <small id="help-dni">Debe contener entre 7 y 8 dígitos numéricos.</small>

      <label for="calle">Calle:</label>
      <input type="text" id="calle" name="calle" required aria-describedby="help-calle"/>
      <small class="error" id="error-calle"></small>
      <small id="help-calle">Puede contener letras y números.</small>
      
      <label for="provincia">Seleccione una provincia:</label>
      <select id="provincia" name="provincia" required>
        <option value="">--Seleccione--</option>
        <option value="Buenos Aires">Buenos Aires</option>
        <option value="Catamarca">Catamarca</option>
        <option value="Chaco">Chaco</option>
        <option value="Chubut">Chubut</option>
        <option value="Córdoba">Córdoba</option>
        <option value="Corrientes">Corrientes</option>
        <option value="Entre Ríos">Entre Ríos</option>
        <option value="Formosa">Formosa</option>
        <option value="Jujuy">Jujuy</option>
        <option value="La Pampa">La Pampa</option>
        <option value="La Rioja">La Rioja</option>
        <option value="Mendoza">Mendoza</option>
        <option value="Misiones">Misiones</option>
        <option value="Neuquén">Neuquén</option>
        <option value="Río Negro">Río Negro</option>
        <option value="Salta">Salta</option>
        <option value="San Juan">San Juan</option>
        <option value="San Luis">San Luis</option>
        <option value="Santa Cruz">Santa Cruz</option>
        <option value="Santa Fe">Santa Fe</option>
        <option value="Santiago del Estero">Santiago del Estero</option>
        <option value="Tierra del Fuego">Tierra del Fuego</option>
        <option value="Tucumán">Tucumán</option>
      </select>
      <small class="error" id="error-provincia"></small>

      <label for="departamento">Departamento:</label>
      <input type="text" id="departamento" name="departamento" required aria-describedby="help-departamento"/>
      <small class="error" id="error-departamento"></small>
      <small id="help-departamento">Puede contener letras y números.</small>

      <label for="localidad">Localidad:</label>
      <input type="text" id="localidad" name="localidad" required aria-describedby="help-localidad"/>
      <small class="error" id="error-localidad"></small>
      <small id="help-localidad">Puede contener letras y números.</small>
    
      <label for="genero">Género:</label>
      <select id="genero" name="genero" required>
        <option value="">--Seleccione--</option>
        <option value="masculino">Masculino</option>
        <option value="femenino">Femenino</option>
        <option value="otro">Otro</option>
      </select>
      <small class="error" id="error-genero"></small>

      <label for="fecha_nacimiento">Fecha de Nacimiento:</label>
      <input type="date" id="fecha_nacimiento" name="fecha_nacimiento" required />
      <small class="error" id="error-fecha"></small>

      <label for="imagen">Imagen de perfil:</label>
      <input type="file" id="imagen" name="imagen" accept=".jpg,.jpeg,.png" required aria-describedby="help-imagen"/>
      <!-- se mostrará una vista previa de la imagen seleccionada -->
      <div id="image-preview-container" style="display: none; margin-top: 10px;">
         <img id="image-preview" src="" alt="Vista previa" style="max-width: 250px; max-height: 250px;">
          <button type="button" id="remove-image" style="display: block; margin-top: 5px;">
            Eliminar imagen
           </button>
      </div>
      <small class="error" id="error-imagen"></small>
      <small id="help-imagen">Formatos permitidos: JPG, JPEG o PNG.</small>

      <!-- Geolocalización automática -->
      <input type="hidden" name="latitud" id="latitud">
      <input type="hidden" name="longitud" id="longitud">
      <p id="geo-msg" style="color: green; font-size: 0.9em;"></p>

      <p><a href="../../docs/RegistroPersona.pdf" download>Proceso de registro de persona (PDF)</a></p>

      <button type="submit">Registrarse</button>
      <p><a href="../loginHtml/login.html">Volver al inicio de sesión</a></p>
    </form>
  </div>

          <!-- Sección del mapa movida aquí (después de la imagen) -->
          <div class="map-section">
            <div class="map-header">
              <h3>Tu ubicación</h3>
              <p>Desplázate por el mapa y haz clic para marcar tu ubicación exacta</p>
            </div>
            <div id="map"></div>
            <div class="coordinates">
              <strong>Coordenadas actuales:</strong>
              <span id="coords-display">Lat: 0.0000, Lon: 0.0000</span>
            </div>
            <div class="map-controls">
              <div class="map-control" id="btn-center" title="Centrar en mi ubicación">
                <i class="fas fa-location-arrow"></i>
              </div>
              <div class="map-control" id="btn-marker" title="Marcar ubicación">
                <i class="fas fa-map-marker-alt"></i>
              </div>
              <div class="map-control" id="btn-reset" title="Restablecer ubicación">
                <i class="fas fa-sync-alt"></i>
              </div>
              <div class="map-control" id="btn-confirm" title="Confirmar ubicación">
                <i class="fas fa-check"></i>
              </div>
            </div>
          </div>

          <!-- Geolocalización automática -->
          <input type="hidden" name="latitud" id="latitud">
          <input type="hidden" name="longitud" id="longitud">
          <p id="geo-msg" style="color: #27ae60; font-size: 0.9em; text-align: center; margin: 10px 0;"></p>

          <button type="submit">Registrarse</button>
          
          <p class="form-link">
            <a href="../loginHtml/login.html">Volver al inicio de sesión</a>
          </p>
          
          <p style="text-align: center; margin-top: 15px;">
            <a href="../../docs/RegistroPersona.pdf" download style="color: #3498db; text-decoration: none;">
              <i class="fas fa-download"></i> Proceso de registro de persona (PDF)
            </a>
          </p>
        </form>
      </div>
    </div>
  </div>

  <footer>
    <p>
      Dirección: Av. Pres. Arturo Illia 902, Catamarca, Argentina | Email:
      contacto@suplementosdynamite.com | Tel: (123) 456-7890
    </p>
    <div class="social-icons">
      <a href="https://wa.me/1234567890" target="_blank"><i class="fab fa-whatsapp"></i></a>
      <a href="https://www.instagram.com/suplementosdynamite" target="_blank"><i class="fab fa-instagram"></i></a>
    </div>
    <p>&copy; 2024 Suplementos Dynamite. Todos los derechos reservados.</p>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const btn = document.querySelector(".btn-exportar");
      if (btn) {
        btn.addEventListener("click", () => {
          const personaId = localStorage.getItem("persona_id");
          if (personaId) {
            const campos = ["nombre", "apellido", "dni", "calle", "provincia", "departamento", "localidad", "genero", "fecha_nacimiento", "imagen"];
            const url = `http://localhost:3000/exportar/pdf?id=${personaId}&campos=${campos.join(",")}`;
            window.open(url, "_blank");
          } else {
            alert("No se encontró ID de persona. Volvé a registrarte.");
          }
        });
      }
    });
  </script>




  <script>
    // Reloj en vivo
    const dateTimeElement = document.getElementById("date-time");
    const updateDateTime = () => {
      const now = new Date();
      const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      };
      dateTimeElement.innerText = now.toLocaleString('es-ES', options);
    };
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // Variables globales para el mapa
    let map;
    let userMarker;
    let clickMarker;
    let userLocation = { lat: -28.4696, lon: -65.7795 }; // Catamarca por defecto
    let coordsDisplay = document.getElementById('coords-display');
    let btnConfirm = document.getElementById('btn-confirm');

    // Iconos personalizados para los marcadores
    const userIcon = L.divIcon({
      className: 'custom-icon',
      html: '<div style="background:#3498db; border-radius:50%; width:30px; height:30px; display:flex; align-items:center; justify-content:center;"><i class="fas fa-user" style="color:white; font-size:16px;"></i></div>',
      iconSize: [30, 30],
      iconAnchor: [15, 15]
    });

    const markerIcon = L.divIcon({
      className: 'custom-icon',
      html: '<div style="background:#e74c3c; border-radius:50%; width:30px; height:30px; display:flex; align-items:center; justify-content:center;"><i class="fas fa-map-marker-alt" style="color:white; font-size:16px;"></i></div>',
      iconSize: [30, 30],
      iconAnchor: [15, 15]
    });

    // Vista previa de imagen
    const imagenInput = document.getElementById('imagen');
    const previewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const removeButton = document.getElementById('remove-image');

    imagenInput.addEventListener('change', function () {
      if (this.files && this.files[0]) {
        const file = this.files[0];
        const reader = new FileReader();

        reader.onload = function (e) {
          imagePreview.src = e.target.result;
          previewContainer.style.display = 'block';
        }

        reader.readAsDataURL(file);
      }
    });

    // Eliminar imagen seleccionada
    removeButton.addEventListener('click', function () {
      imagenInput.value = '';
      imagePreview.src = '';
      previewContainer.style.display = 'none';
    });

    // Validar archivo
    function validarArchivo(input) {
      if (!input.files || input.files.length === 0) return false;

      const archivo = input.files[0];
      const extensionesPermitidas = ["jpg", "jpeg", "png"];
      const extension = archivo.name.split('.').pop().toLowerCase();

      return extensionesPermitidas.includes(extension);
    }

    // Validaciones
    function soloTexto(valor) {
      return /^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$/.test(valor.trim());
    }

    function soloNumeros(valor) {
      return /^\d+$/.test(valor);
    }

    function textoYNumeros(valor) {
      return /^[A-Za-z0-9\s]+$/.test(valor.trim());
    }

    // Función para inicializar el mapa
    function initMap(lat, lon) {
      if (map) map.remove();

      // Crear el mapa
      map = L.map('map').setView([lat, lon], 15);

      // Añadir capa de tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      // Crear marcador de usuario
      userMarker = L.marker([lat, lon], {icon: userIcon}).addTo(map)
        .bindPopup('Tu ubicación detectada')
        .openPopup();

      // Evento para agregar marcadores al hacer clic
      map.on('click', function (e) {
        // Eliminar marcador anterior si existe
        if (clickMarker) map.removeLayer(clickMarker);
        
        // Crear nuevo marcador
        clickMarker = L.marker(e.latlng).addTo(map)
          .bindPopup('Ubicación seleccionada')
          .openPopup();

        // Actualizar coordenadas
        updateCoordinates(e.latlng.lat, e.latlng.lng);
        
        // Mostrar botón de confirmación
        btnConfirm.style.display = 'flex';
      });

      // Actualizar coordenadas
      updateCoordinates(lat, lon);
    }

    // Actualizar coordenadas en la UI
    function updateCoordinates(lat, lon) {
      document.getElementById("latitud").value = lat;
      document.getElementById("longitud").value = lon;
      coordsDisplay.textContent = `Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}`;
    }

    // Centrar en la ubicación del usuario
    function centerOnUser() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          function (position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            map.setView([lat, lon], 15);
            userLocation = { lat, lon };

            // Mover marcador de usuario
            userMarker.setLatLng([lat, lon]);
            updateCoordinates(lat, lon);

            document.getElementById("geo-msg").textContent = "Ubicación actualizada correctamente.";
          },
          function (error) {
            Swal.fire({
              icon: 'error',
              title: 'Error de geolocalización',
              text: 'No se pudo obtener tu ubicación. Asegúrate de tener los permisos activados.'
            });
          }
        );
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Tu navegador no soporta geolocalización.'
        });
      }
    }

    // Confirmar nueva ubicación
    function confirmLocation() {
      if (!clickMarker) return;
      
      const newLat = clickMarker.getLatLng().lat;
      const newLon = clickMarker.getLatLng().lng;
      
      Swal.fire({
        title: '¿Confirmar nueva ubicación?',
        text: '¿Estás seguro de que deseas reemplazar tu ubicación actual por esta nueva ubicación?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#2ecc71',
        cancelButtonColor: '#e74c3c',
        confirmButtonText: 'Sí, confirmar',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          // Actualizar ubicación del usuario
          userLocation = { lat: newLat, lon: newLon };
          userMarker.setLatLng([newLat, newLon]);
          
          // Eliminar marcador manual
          map.removeLayer(clickMarker);
          clickMarker = null;
          
          // Actualizar coordenadas
          updateCoordinates(newLat, newLon);
          
          // Ocultar botón de confirmación
          btnConfirm.style.display = 'none';
          
          // Mostrar mensaje de éxito
          Swal.fire({
            icon: 'success',
            title: 'Ubicación actualizada',
            text: 'Tu ubicación ha sido reemplazada correctamente.',
            timer: 2000,
            showConfirmButton: false
          });
        }
      });
    }

    // Obtener ubicación y mostrar en el mapa
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        function (position) {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          userLocation = { lat, lon };

          // Asignar valores a los inputs ocultos
          document.getElementById("latitud").value = lat;
          document.getElementById("longitud").value = lon;

          // Mostrar mensaje
          document.getElementById("geo-msg").textContent = "Ubicación detectada correctamente.";

          // Mostrar mapa
          initMap(lat, lon);
        },
        function (error) {
          // Usar ubicación por defecto si falla
          document.getElementById("geo-msg").textContent = "No se pudo obtener tu ubicación. Usando ubicación por defecto (Catamarca).";
          initMap(userLocation.lat, userLocation.lon);
        }
      );
    } else {
      document.getElementById("geo-msg").textContent = "Tu navegador no soporta geolocalización. Usando ubicación por defecto.";
      initMap(userLocation.lat, userLocation.lon);
    }

    // Eventos para los controles del mapa
    document.getElementById('btn-center').addEventListener('click', centerOnUser);

    document.getElementById('btn-marker').addEventListener('click', function () {
      Swal.fire({
        icon: 'info',
        title: 'Marcar ubicación',
        text: 'Haz clic en cualquier lugar del mapa para marcar tu ubicación exacta.',
        timer: 2000,
        showConfirmButton: false
      });
    });

    document.getElementById('btn-reset').addEventListener('click', function () {
      if (clickMarker) {
        map.removeLayer(clickMarker);
        clickMarker = null;
        btnConfirm.style.display = 'none';
      }
      updateCoordinates(userLocation.lat, userLocation.lon);
      Swal.fire({
        icon: 'success',
        title: 'Ubicación restablecida',
        text: 'Se ha restablecido a tu ubicación original.',
        timer: 2000,
        showConfirmButton: false
      });
    });
    
    document.getElementById('btn-confirm').addEventListener('click', confirmLocation);

    // Validación de fecha de nacimiento
    document.getElementById("fecha_nacimiento").addEventListener("change", function () {
      const fecha = new Date(this.value);
      const hoy = new Date();
      const errorFecha = document.getElementById("error-fecha");
      errorFecha.textContent = "";

      if (fecha >= hoy) {
        errorFecha.textContent = "La fecha de nacimiento no puede ser futura.";
        this.classList.add("error-field");
        return;
      }

      // Verificar si es mayor de edad (18 años)
      const edad = hoy.getFullYear() - fecha.getFullYear();
      const m = hoy.getMonth() - fecha.getMonth();
      const d = hoy.getDate() - fecha.getDate();
      let esMayor = edad > 18 || (edad === 18 && (m > 0 || (m === 0 && d >= 0)));

      if (!esMayor) {
        errorFecha.textContent = "Debes ser mayor de 18 años para registrarte.";
        this.classList.add("error-field");
      } else {
        this.classList.remove("error-field");
        this.classList.add("success-field");
      }
    });

    // Validación en tiempo real
    document.querySelectorAll('input, select').forEach(input => {
      input.addEventListener('blur', function () {
        const errorId = `error-${this.id}`;
        const errorElement = document.getElementById(errorId);
        if (!errorElement) return;

        errorElement.textContent = "";
        this.classList.remove("error-field", "success-field");

        // Validaciones específicas
        if (this.id === 'nombre' || this.id === 'apellido') {
          if (!soloTexto(this.value) || this.value.trim().length < 3) {
            errorElement.textContent = this.id === 'nombre' ?
              "El nombre debe contener solo letras y al menos 3 caracteres." :
              "El apellido debe contener solo letras y al menos 3 caracteres.";
            this.classList.add("error-field");
          } else {
            this.classList.add("success-field");
          }
        }

        if (this.id === 'dni') {
          if (!soloNumeros(this.value) || this.value.length < 7 || this.value.length > 8) {
            errorElement.textContent = "El DNI debe tener entre 7 y 8 dígitos numéricos.";
            this.classList.add("error-field");
          } else {
            this.classList.add("success-field");
          }
        }

        if (this.id === 'calle') {
          if (!textoYNumeros(this.value)) {
            errorElement.textContent = "La calle debe contener solo letras y/o números.";
            this.classList.add("error-field");
          } else {
            this.classList.add("success-field");
          }
        }

        if (this.id === 'provincia' || this.id === 'genero') {
          if (!this.value) {
            errorElement.textContent = "Este campo es obligatorio.";
            this.classList.add("error-field");
          } else {
            this.classList.add("success-field");
          }
        }
      });
    });

    // Lógica para cargar provincias, departamentos, municipios y localidades
    const provinciaSelect = document.getElementById('provincia');
    const departamentoSelect = document.getElementById('departamento');
    const municipioSelect = document.getElementById('municipio');
    const localidadSelect = document.getElementById('localidad');

    // Funciones para resetear selects dependientes
    function resetDepartamentos() {
        departamentoSelect.innerHTML = '<option value="">--Seleccione--</option>';
        departamentoSelect.disabled = true;
        resetMunicipios();
    }

    function resetMunicipios() {
        municipioSelect.innerHTML = '<option value="">--Seleccione--</option>';
        municipioSelect.disabled = true;
        resetLocalidades();
    }

    function resetLocalidades() {
        localidadSelect.innerHTML = '<option value="">--Seleccione--</option>';
        localidadSelect.disabled = true;
    }

    // Función para cargar provincias
    async function cargarProvincias() {
        try {
            const resp = await fetch('../api/provincia');
            const provincias = await resp.json();
            
            provinciaSelect.innerHTML = '<option value="">--Seleccione--</option>';
            provincias.forEach(provincia => {
                const option = document.createElement('option');
                option.value = provincia.id;  // Cambiado: guarda el ID de value
             // option.dataset.id = provincia.id;
                option.textContent = provincia.nombre;
                provinciaSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error cargando provincias:', error);
        }
    }

    // Función para cargar departamentos por provincia
    async function cargarDepartamentos(provinciaId) {
        try {
            const resp = await fetch(`../api/departamentos?provinciaId=${provinciaId}`);
            const departamentos = await resp.json();
            
            departamentoSelect.innerHTML = '<option value="">--Seleccione--</option>';
            departamentos.forEach(depto => {
                const option = document.createElement('option');
                option.value = depto.id;  // Cambiado: guarda el ID de value
                //option.dataset.id = depto.id;
                option.textContent = depto.nombre;
                departamentoSelect.appendChild(option);
            });
            
            departamentoSelect.disabled = false;
            resetMunicipios();
        } catch (error) {
            console.error('Error cargando departamentos:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No se pudieron cargar los departamentos. Por favor intenta nuevamente.'
        });
      }
    }

    // Función para cargar municipios por departamento
    async function cargarMunicipios(departamentoId) {
        try {
            const resp = await fetch(`../api/municipios?departamentoId=${departamentoId}`);
            const municipios = await resp.json();
            
            municipioSelect.innerHTML = '<option value="">--Seleccione--</option>';
            municipios.forEach(muni => {
                const option = document.createElement('option');
                option.value = muni.id;  // Cambiado: guarda el ID de value
                //option.dataset.id = muni.id;
                option.textContent = muni.nombre;
                municipioSelect.appendChild(option);
            });
            
            municipioSelect.disabled = false;
            resetLocalidades();
        } catch (error) {
            console.error('Error cargando municipios:', error);
        }
    }

    // Función para cargar localidades por municipio
    async function cargarLocalidades(municipioId) {
        try {
            const resp = await fetch(`../api/localidades?municipioId=${municipioId}`);
            const localidades = await resp.json();
            
            localidadSelect.innerHTML = '<option value="">--Seleccione--</option>';
            localidades.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc.nombre;
                option.textContent = loc.nombre;
                localidadSelect.appendChild(option);
            });
            
            localidadSelect.disabled = false;
        } catch (error) {
            console.error('Error cargando localidades:', error);
        }
    }

    // Event listeners para los selects
    provinciaSelect.addEventListener('change', function() {
        if (this.value) {
            const selectedOption = this.options[this.selectedIndex];
            const provinciaId = this.options[this.selectedIndex].value;  // Cambiado
            cargarDepartamentos(provinciaId);
        } else {
            resetDepartamentos();
        }
    });

    departamentoSelect.addEventListener('change', function() {
        if (this.value) {
            const selectedOption = this.options[this.selectedIndex];
            const departamentoId = this.options[this.selectedIndex].value; // Cambiado
            cargarMunicipios(departamentoId);
        } else {
            resetMunicipios();
        }
    });

    municipioSelect.addEventListener('change', function() {
        if (this.value) {
            const selectedOption = this.options[this.selectedIndex];
            const municipioId = this.options[this.selectedIndex].value;  // Cambiado
            cargarLocalidades(municipioId);
        } else {
            resetLocalidades();
        }
    });

    // Inicialización: cargar provincias y resetear selects dependientes
    document.addEventListener('DOMContentLoaded', function() {
        resetDepartamentos();
        resetMunicipios();
        resetLocalidades();
        cargarProvincias();
    });

    // Envío del formulario con SweetAlert2
    document.getElementById('register-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      // Validar todos los campos
      let valid = true;
      const campos = [
        'nombre', 'apellido', 'dni', 'calle', 'provincia', 
        'departamento', 'localidad', 'genero', 'fecha_nacimiento', 'imagen'
      ];
      
      campos.forEach(campo => {
        const element = document.getElementById(campo);
        const errorElement = document.getElementById(`error-${campo}`);
        
        if (!errorElement) return;
        
        errorElement.textContent = "";
        element.classList.remove("error-field");
        
        // Validación básica de campo requerido
        if (!element.value) {
          errorElement.textContent = "Este campo es obligatorio.";
          element.classList.add("error-field");
          valid = false;
        }
      });

        // Validación adicional para imagen
        const imagen = document.getElementById('imagen');
        if (!validarArchivo(imagen)) {
            document.getElementById('error-imagen').textContent = "Debe subir una imagen JPG, JPEG o PNG válida.";
            imagen.classList.add("error-field");
            valid = false;
        }

        // Si hay errores, mostrar alerta
        if (!valid) {
            Swal.fire({
                icon: 'error',
                title: 'Formulario incompleto',
                text: 'Por favor, complete todos los campos correctamente.',
                confirmButtonText: 'Entendido'
            });
            return;
        }

      // Enviar formulario
      const formData = new FormData(this);
      
      try {
        const resp = await fetch('http://localhost:3000/personas', {
          method: 'POST',
          body: formData
        });
        
        const resultado = await resp.json();
        
        if (resp.ok) {
          Swal.fire({
            icon: 'success',
            title: '¡Registro exitoso!',
            text: 'Tu cuenta ha sido creada correctamente.',
            confirmButtonText: 'Aceptar'
          }).then(() => {
            window.location.href = "/html/loginHtml/login.html";
          });
        } else {
          // Manejar error dni duplicado
          if (resp.status === 409 && resultado.campo === 'dni') {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: resultado.error,
              confirmButtonText: 'Entendido'
            });
            document.getElementById("dni").focus();
            document.getElementById("dni").select();
            return;
          }
          Swal.fire({
            icon: 'error',
            title: 'Error al registrar',
            text: resultado.error || 'Error desconocido',
            confirmButtonText: 'Entendido'
          });
        }
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'Error de conexión',
          text: 'No se pudo conectar con el servidor. Intente nuevamente.',
          confirmButtonText: 'Entendido'
        });
      }
    });
</script>
</body>

</html>