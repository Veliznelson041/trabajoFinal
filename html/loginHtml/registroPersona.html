<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registro de Persona</title>
  <link rel="stylesheet" href="../../css/loginCss/register.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <!-- Leaflet CSS y JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <header>
    <div class="header-container">
      <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRt_eZYMvS26mdHNwVQw-zHWqDRdSz5XzAVHQ&s"
        alt="Logo de Suplementos Dynamite" class="logo"/>
      <h1 id="title">Suplementos Dynamite</h1>
    </div>
    <p id="date-time"></p>
    <nav class="nav-bar">
      <ul>
        <li><a href="../index.html">Inicio</a></li>
        <li><a href="/html/catalogo-Carrito-Producto-HTML/catalogo.html">Catálogo</a></li>
        <li><a href="../contactoHtml/contacto.html">Contacto</a></li>
        <li><a href="/html/loginHtml/login.html" class="btn-login"><i class="fas fa-user"></i> Iniciar Sesión</a></li>
      </ul>
    </nav>
  </header>

  <nav class="ruta">
    <a href="../index.html">Inicio</a> &gt;
    <a href="login.html">Iniciar Sesión</a> &gt;
    <a href="../loginHtml/register.html">Registrarse</a>
  </nav>

  <div class="container">
    <h1>Registro de Persona</h1>
    <form id="register-form" novalidate>
      <label for="nombres">Nombres:</label>
      <input type="text" id="nombre" name="nombre" required aria-describedby="help-nombres"/>
      <small id="help-nombres">Solo letras. No se permiten números ni símbolos.</small>

      <label for="apellidos">Apellidos:</label>
      <input type="text" id="apellido" name="apellido" required aria-describedby="help-apellidos"/>
      <small id="help-apellidos">Solo letras. No se permiten números ni símbolos.</small>

      <label for="dni">DNI:</label>
      <input type="text" id="dni" name="dni" required maxlength="8" minlength="7" aria-describedby="help-dni"/>
      <small id="help-dni">Debe contener entre 7 y 8 dígitos numéricos.</small>

      <label for="calle">Calle:</label>
      <input type="text" id="calle" name="calle" required aria-describedby="help-calle"/>
      <small id="help-calle">Puede contener letras y números.</small>
      
      <label for="provincia">Seleccione una provincia:</label>
      <select id="provincia" name="provincia" required>
        <option value="">--Seleccione--</option>
        <option value="Buenos Aires">Buenos Aires</option>
        <option value="Catamarca">Catamarca</option>
        <option value="Chaco">Chaco</option>
        <option value="Chubut">Chubut</option>
        <option value="Córdoba">Córdoba</option>
        <option value="Corrientes">Corrientes</option>
        <option value="Entre Ríos">Entre Ríos</option>
        <option value="Formosa">Formosa</option>
        <option value="Jujuy">Jujuy</option>
        <option value="La Pampa">La Pampa</option>
        <option value="La Rioja">La Rioja</option>
        <option value="Mendoza">Mendoza</option>
        <option value="Misiones">Misiones</option>
        <option value="Neuquén">Neuquén</option>
        <option value="Río Negro">Río Negro</option>
        <option value="Salta">Salta</option>
        <option value="San Juan">San Juan</option>
        <option value="San Luis">San Luis</option>
        <option value="Santa Cruz">Santa Cruz</option>
        <option value="Santa Fe">Santa Fe</option>
        <option value="Santiago del Estero">Santiago del Estero</option>
        <option value="Tierra del Fuego">Tierra del Fuego</option>
        <option value="Tucumán">Tucumán</option>
      </select>

      <label for="departamento">Departamento:</label>
      <input type="text" id="departamento" name="departamento" required aria-describedby="help-departamento"/>
      <small id="help-departamento">Puede contener letras y números.</small>

      <label for="localidad">Localidad:</label>
      <input type="text" id="localidad" name="localidad" required aria-describedby="help-localidad"/>
      <small id="help-localidad">Puede contener letras y números.</small>
    
      <label for="genero">Género:</label>
      <select id="genero" name="genero" required>
        <option value="">--Seleccione--</option>
        <option value="masculino">Masculino</option>
        <option value="femenino">Femenino</option>
        <option value="otro">Otro</option>
      </select>

      <label for="fecha_nacimiento">Fecha de Nacimiento:</label>
      <input type="date" id="fecha_nacimiento" name="fecha_nacimiento" required />

      <label for="imagen">Imagen de perfil:</label>
      <input type="file" id="imagen" name="imagen" accept=".jpg,.jpeg,.png" required aria-describedby="help-imagen"/>
      <!-- se mostrará una vista previa de la imagen seleccionada -->
      <div id="image-preview-container" style="display: none; margin-top: 10px;">
         <img id="image-preview" src="" alt="Vista previa" style="max-width: 250px; max-height: 250px;">
          <button type="button" id="remove-image" style="display: block; margin-top: 5px;">
            Eliminar imagen
           </button>
      </div>

      <small id="help-imagen">Formatos permitidos: JPG, JPEG o PNG.</small>


      <!-- Geolocalización automática -->
      <input type="hidden" name="latitud" id="latitud">
      <input type="hidden" name="longitud" id="longitud">
      <p id="geo-msg" style="color: green; font-size: 0.9em;"></p>


      <p><a href="../../docs/RegistroPersona.pdf" download>Proceso de registro de persona (PDF)</a></p>

      <button type="submit">Registrarse</button>
      <p><a href="../loginHtml/login.html">Volver al inicio de sesión</a></p>
    </form>
  </div>

  <!-- Mapa de ubicación -->
<h3>Tu ubicación detectada</h3>
<div id="map" style="height: 300px; width: 100%; margin-bottom: 20px;"></div>


  <footer>
    <p>
      Dirección: Av. Pres. Arturo Illia 902, Catamarca, Argentina | Email:
      contacto@suplementosdynamite.com | Tel: (123) 456-7890
    </p>
    <div class="social-icons">
      <a href="https://wa.me/1234567890" target="_blank"><i class="fab fa-whatsapp"></i></a>
      <a href="https://www.instagram.com/suplementosdynamite" target="_blank"><i class="fab fa-instagram"></i></a>
    </div>
    <p>&copy; 2024 Suplementos Dynamite. Todos los derechos reservados.</p>
  </footer>

  <script>
    // Reloj en vivo
    const dateTimeElement = document.getElementById("date-time");
    const updateDateTime = () => {
      const now = new Date();
      dateTimeElement.innerText = now.toLocaleString();
    };
    setInterval(updateDateTime, 1000);
    updateDateTime();

      // Vista previa de imagen
     const imagenInput = document.getElementById('imagen');
     const previewContainer = document.getElementById('image-preview-container');
     const imagePreview = document.getElementById('image-preview');
     const removeButton = document.getElementById('remove-image');

    imagenInput.addEventListener('change', function() {
    if (this.files && this.files[0]) {
      const file = this.files[0];
      const reader = new FileReader();
      
      reader.onload = function(e) {
        imagePreview.src = e.target.result;
        previewContainer.style.display = 'block';
      }
      
      reader.readAsDataURL(file);
    }
    });

    // Eliminar imagen seleccionada
    removeButton.addEventListener('click', function() {
      imagenInput.value = '';
      imagePreview.src = '';
      previewContainer.style.display = 'none';
    });

    // Validar archivo (actualizado)
    function validarArchivo(input) {
      if (!input.files || input.files.length === 0) return false;
      
      const archivo = input.files[0];
      const extensionesPermitidas = ["jpg", "jpeg", "png", "svg"];
      const extension = archivo.name.split('.').pop().toLowerCase();
      
      return extensionesPermitidas.includes(extension);
    }

    // Validaciones
    function soloTexto(valor) {
      return /^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$/.test(valor.trim());
    }

    function soloNumeros(valor) {
      return /^\d+$/.test(valor);
    }

    function textoYNumeros(valor) {
      return /^[A-Za-z0-9\s]+$/.test(valor.trim());
    }

    function validarArchivo(input) {
      const archivo = input.files[0];
      if (!archivo) return false;
      const extensionesPermitidas = ["jpg", "jpeg", "png","svg"];
      const extension = archivo.name.split(".").pop().toLowerCase();
      return extensionesPermitidas.includes(extension);
    }
    
    // Validación de fecha de nacimiento
    document.getElementById("fecha_nacimiento").addEventListener("change", function() {
      const fecha = new Date(this.value);
      const hoy = new Date();
      if (fecha >= hoy) {
        alert("La fecha de nacimiento no puede ser futura.");
        this.value = "";
        return;
      }
      // Verificar si es mayor de edad (18 años)
      const edad = hoy.getFullYear() - fecha.getFullYear();
      const m = hoy.getMonth() - fecha.getMonth();
      const d = hoy.getDate() - fecha.getDate();
      let esMayor = edad > 18 || (edad === 18 && (m > 0 || (m === 0 && d >= 0)));
      if (!esMayor) {
        alert("Debes ser mayor de 18 años para registrarte.");
        this.value = "";
      }
  
    }); 



    // Geolocalización automática
if ("geolocation" in navigator) {
  navigator.geolocation.getCurrentPosition(
    function (position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;

      document.getElementById("latitud").value = lat;
      document.getElementById("longitud").value = lon;

      document.getElementById("geo-msg").textContent =
        "Ubicación detectada correctamente.";
    },
    function (error) {
      document.getElementById("geo-msg").textContent =
        "No se pudo obtener tu ubicación. Activa los permisos de geolocalización.";
      console.error("Error de geolocalización:", error);
    }
  );
} else {
  document.getElementById("geo-msg").textContent =
    "Tu navegador no admite geolocalización.";
}





    document.getElementById('register-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      const nombres = document.getElementById("nombre").value;
      const apellidos = document.getElementById("apellido").value;
      const dni = document.getElementById("dni").value;
      const calle = document.getElementById("calle").value;
      const imagen = document.getElementById("imagen");

      let errores = [];

      if (!soloTexto(nombres)) errores.push("El nombre debe contener solo letras .");
      if (nombres.trim().length < 3) errores.push("El nombre debe contener 3 letras o más.");
      if (!soloTexto(apellidos)) errores.push("El apellido debe contener solo letras.");
      if (apellidos.trim().length < 3) errores.push("El apellido debe contener 3 letras o más.");

      if (!soloNumeros(dni) || dni.length < 7 || dni.length > 8)
        errores.push("El DNI debe tener entre 7 y 8 dígitos numéricos.");
      if (!textoYNumeros(calle)) errores.push("La calle debe contener solo letras y/o números.");
      if (!validarArchivo(imagen)) errores.push("Debe subir una imagen JPG, JPEG o PNG válida.");

      if (errores.length > 0) {
        alert(errores.join("\n"));
      } else {
        alert("Formulario válido. Enviando...");
        // Aquí podés enviar al backend si tenés configurado
        // this.submit(); // o enviar con fetch si es SPA
        // window.location.href = "register.html";

        const formulario = document.getElementById('register-form');
        const formData = new FormData(formulario);
        try {
          const resp = await fetch('http://localhost:3000/personas', {
            method: 'POST',
            body: formData
          });
          const resultado = await resp.json();
          if (resp.ok) {
            alert("Registro exitoso");
            window.location.href ="/html/loginHtml/register.html";
          } else {
          // manejar error dni duplicado
          if (resp.status === 409 && resultado.campo === 'dni') {
            alert('Error: ' + resultado.error);
            document.getElementById("dni").focus();
            document.getElementById("dni").select();
            return;
          }
            alert("Error al registrar la persona: " + resultado.error);
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

    });


    // Geolocalización
    window.onload = function () {
      const latInput = document.getElementById('latitud');
      const lonInput = document.getElementById('longitud');
      const geoMsg = document.getElementById('geo-msg');

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          latInput.value = position.coords.latitude;
          lonInput.value = position.coords.longitude;
          geoMsg.textContent = `Ubicación detectada correctamente.`;
        }, function () {
          geoMsg.textContent = "No se pudo obtener la ubicación. Asegúrese de permitir el acceso.";
          geoMsg.style.color = "red";
        });
      } else {
        geoMsg.textContent = "El navegador no soporta geolocalización.";
        geoMsg.style.color = "red";
      }
    }



  // Función para inicializar el mapa
  function mostrarMapa(lat, lon) {
    const mapa = L.map('map').setView([lat, lon], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(mapa);
    L.marker([lat, lon]).addTo(mapa)
      .bindPopup('Tu ubicación detectada')
      .openPopup();
  }

  // Obtener ubicación y mostrar en el mapa
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;

        // Asignar valores a los inputs ocultos
        document.getElementById("latitud").value = lat;
        document.getElementById("longitud").value = lon;

        // Mostrar mensaje
        document.getElementById("geo-msg").innerText = "Ubicación detectada correctamente.";

        // Mostrar mapa
        mostrarMapa(lat, lon);
      },
      function(error) {
        document.getElementById("geo-msg").innerText = "No se pudo obtener tu ubicación.";
      }
    );
  } else {
    document.getElementById("geo-msg").innerText = "Tu navegador no soporta geolocalización.";
  }
</script>


  </script>
</body>
</html>
